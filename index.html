<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Falcon Run ‚Äì Asteroides & TIE</title>
  <style>
    :root{
      --bg1:#040510;
      --bg2:#08102a;
      --fg:#e9eef7;
      --muted:#9aa7bd;
      --accent:#7dd3fc;
      --laser:rgb(70,255,0);
    }
    *{box-sizing:border-box}
   html, body{
	  height: 100%;
	  touch-action: none;
	  overscroll-behavior: none;
		  -webkit-text-size-adjust: 100%;
	}

	body{
	  margin:0;
	  min-height: var(--appH, 100dvh);
	  padding-bottom: env(safe-area-inset-bottom);

	  display:grid;
	  place-items:center;

	  background:radial-gradient(1100px 650px at 25% 10%, #1a2a55 0%, var(--bg1) 60%, #02030a 100%);
	  color:var(--fg);
	  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
	  overflow:hidden;
	}

    .wrap{ width:min(980px, 96vw); user-select:none; }
    .hud{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin:0 0 10px 0; color:var(--muted); font-size:14px;
    }
	.hud-right{
	  display:flex;
	  align-items:center;
	  gap:10px;
	}
    .hud b{ color:var(--fg); }
    canvas{
      width:100%;
      height:auto;
      border-radius:16px;
      background:linear-gradient(var(--bg2), var(--bg1) 65%);
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
      outline: 1px solid rgba(255,255,255,.08);
      display:block;
      touch-action: none;
    }
    .hint{ margin-top:10px; color:var(--muted); font-size:13px; line-height:1.35; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      outline:1px solid rgba(255,255,255,.08);
    }
        .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(125,211,252,.15);
    }

    /* üîä Bot√≥n m√∫sica ON/OFF */
	#musicToggle{
	  font-size: 16px;
	  padding: 4px 8px;
	  border-radius: 8px;
	  border: none;

	  background: rgba(255,255,255,.08);
	  color: var(--fg);
	  cursor: pointer;

	  line-height: 1;
	  user-select: none;
	}
	#musicToggle:hover{
	  background: rgba(255,255,255,.14);
	}
	#musicToggle:active{
	  transform: scale(0.95);
	}


  </style>
</head>
<body>
  <div class="wrap">
   <div class="hud">
	  <div class="pill">
		<span class="dot"></span>
		<span>Impulso con <b>Espacio</b> o <b>Click</b></span>
	  </div>

	  <div class="hud-right">
		<span>Puntos: <b id="score">0</b> ¬∑ R√©cord: <b id="best">0</b></span>
		<button id="musicToggle" aria-label="M√∫sica">üîä</button>
	  </div>
	</div>


    <canvas id="c" width="960" height="440"></canvas>
	
  </div>

<script>
(() => {

  // iOS Safari: ajustar alto real visible (evita corte por barras al girar)
  function setAppHeight(){
    const h = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
    document.documentElement.style.setProperty("--appH", `${h}px`);
  }
  setAppHeight();
  window.addEventListener("resize", setAppHeight);
  window.addEventListener("orientationchange", setAppHeight);
  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", setAppHeight);
  }
  
  const canvas = document.getElementById("c");
  // --- iOS Safari: evitar zoom por doble-tap / gestos ---
  // Bloquea gesture zoom (pinch/double-tap)
  document.addEventListener('gesturestart', (e) => e.preventDefault());
  document.addEventListener('gesturechange', (e) => e.preventDefault());
  document.addEventListener('gestureend', (e) => e.preventDefault());

  // Bloquea double-tap zoom en iOS (sin romper taps normales)
  let __lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - __lastTouchEnd <= 300) {
      e.preventDefault();
    }
    __lastTouchEnd = now;
  }, { passive: false });

  // Evita scroll/zoom al tocar el canvas
  canvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
  canvas.addEventListener('touchmove',  (e) => e.preventDefault(), { passive: false });

	// ===== AUDIO =====
	let musicStarted = false;
	let audioUnlocked = false;
	let audioUnlockPromise = null;
	let laserCtx = null;
	let laserBuf = null;
	let laserGain = null;
	let crashBuf = null;
	let sfxGain = null;  // ganancia para FX

	//let musicEnabled = true;
	let audioEnabled = localStorage.getItem("audioEnabled") !== "false";
	
	async function initLaserWebAudio(){
	  if (laserCtx) return;

	  laserCtx = new (window.AudioContext || window.webkitAudioContext)();

	  // Ganancia general para FX (laser + crash)
	  sfxGain = laserCtx.createGain();
	  sfxGain.gain.value = 0.75;
	  sfxGain.connect(laserCtx.destination);

	  // Ganancia espec√≠fica del l√°ser
	  laserGain = laserCtx.createGain();
	  laserGain.gain.value = 0.45;
	  laserGain.connect(sfxGain);

	  const load = async (url) => {
		const res = await fetch(url);
		const arr = await res.arrayBuffer();
		return await laserCtx.decodeAudioData(arr);
	  };

	  // Cargamos ambos buffers (l√°ser y explosi√≥n)
	  [laserBuf, crashBuf] = await Promise.all([
		load("audio/8-bit-laser.mp3"),
		load("audio/8-bit-explosion.mp3")
	  ]);
	}



	function saveAudioPref(){
	  localStorage.setItem("audioEnabled", audioEnabled);
	}


	const sfxCrash = new Audio("audio/8-bit-explosion.mp3");
	sfxCrash.volume = 0.9;

	const sfxLaser = new Audio("audio/8-bit-laser.mp3");
	sfxLaser.volume = 0.6;

	const music = new Audio("audio/8-bit-music.mp3");
	music.loop = true;
	music.volume = 0.20;

	// ---- Bot√≥n m√∫sica ----
	const musicBtn = document.getElementById("musicToggle");

	function updateMusicIcon(){
	  musicBtn.textContent = audioEnabled ? "üîä" : "üîá";
	}

	musicBtn.addEventListener("click", () => {
	  unlockAudio().then(() => {
		audioEnabled = !audioEnabled;
		saveAudioPref();
		updateMusicIcon();

		if (!audioEnabled){
		  stopMusic();
		} else if (!gameOver && running){
		  musicStarted = true;
		  startMusic();
		}
	  });
	});


	updateMusicIcon();



	
function startMusic(){
  //if (!musicEnabled) return;
  if (!audioEnabled) return;
  if (!audioUnlocked) return;
  if (!music.paused) return;

  music.currentTime = 0;
  music.play().catch(()=>{});
}


function stopMusic(){
  if (!music.paused) music.pause();
}



  // --- HALC√ìN: tu imagen embebida (con fondo transparente) ---
// --- HALC√ìN: PNG embebido (tu imagen) + fondo negro transparente ---
	const falconImg = new Image();
	falconImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAA8CAYAAADxJz2MAAAACXBIWXMAAC4jAAAuIwF4pT92AAANmklEQVR4nO1cW2wc1Rn+5rLrtXdt767txA4Qu7FT4jhBufSFEBdCycXeRkSNixoLCojISaMQCQQS8NY+kTSIlyYSEQ+FyNi59aEK5GLHRVwSNRcIFF9CSGKKSiF2fFm82cvMOdOH8Zmdy87OXoOQ+kl+OGfOzjnzz3++/3L+MYcio7W19XBZWdm8TMe///77m+Lx+Hgx11RIiMWeoKqqaqXP51uQ6Xie593FXE+hUTABtra29nq93vnm/rVr187z+Xy4cP4rxGISGhoqILp47frojTBkmWLtupXweNyIRqN/j0QiCfN9BgYGQolEYrJQ6y0UCibAQCCwrKKi4l5zf3V1NXw+H0TxW/B8HGVeH9zupAAFIQFKKWpq5sDr9aC6unplaWmp5f48z7sKtdZCImcBrl69utfn8zWwdkdHR73f77eMEwTB0JblGnCcXhbTAKjW2rhxIyilMCMSiZyIRqMSa585c2a9JEnTua6/UMhZgIFA4L7Kyspm1p47dy5SCXBychKEEK2tUDcUqqc5zjC+pqYm5XzV1dUrotGo1uZ5vuj8nQmyXkRra2uvz+db0NHR0RAIBLT+8vLyzCZ03YTLrddKYrje0NAAURQxOjoKWZa1/kcffdSgmZFIpC8Wi8n9/f2PSJIUzvY5CoWsBej3+5dUVla2zJkzB8FgMOsJOU4Cx+mFphiul5aWwuWy0p1ZM6uqqpbHYjFwHPejamLGk4dCoct+v7+ls7NTCAaD4Hk+5bhjRz9AOHwbmzt+iYqKMst1KXEXoOi3cBiAxehqaG5uhiiKGB4eNmjkM888AwAoKSn5PhaL4ciRIzWJRGIq0+cpFDIWIMdxAsdxIs/ztsIDAKoAlCq217MFx3HgOM7Sz9bAcZw4e9066A7AUYCzmreU4zh7qQE4dvRDTE9HsGLFgygt9WJocAyEzGBBIw/9jnS5/2NwYwDZcq90WLx4MURRxODgIAgh2Lp1KwDA7XaPx+NxHD58OHgnrbOjADmO452EBwCKokBRFKiKwP6KD6ads+tMqa3FhK0A29vbLwUCgft27dol1NbWav2BQACiKOLLL79EPB7X+n+zuRUA8OknExgfD+P69UFIUhx337MULleJNi5bDswUTBNdLtd4IpG836FDhwKyLM/kPYENbAVox3k8z9twEtME1sM08s6ArZHneVG/Pq7IKmm5+azmLdu1axdfV1dnuyUCgQAEQcCVK1cMmsjAhDc1NQVCCPpOf47bt+NY1Bw0cODw0AQkieJ3W9bA6/Xg66+/BiEE9fX1EATB0jZzYEtLCwRB0Nps3gMHDiCRSEBRFENY09vbW04IuZ2HzAywaCDjvHz5JJ/f6jU3ya25zWvm70IrZM5O6OSkmhhpbGyEIAgWTrSDEwfOn68mdNiD1tfXG9pmDA0NAYCtkLu6ugyOuSAI03p/sre310cIcV64DfL24gtt+VJoUNrxTtpp5nCd31gQaAJsa2u7GAwGl5u578KFW4jMyJicHAMhMtatX4SKCo92A6aJTU1NaTmRwckPbG5uhsvlwtDQEGRZ1jiPtc1gHMjAuLCrqwuAyoWSJGHbtm1wuVzYvn274fc8z9/WJzt6enpKKKUZO6eaAG25TwEU3d9PBewZzByaiiPz0UjHLTw5OY7p6ShGR4cRj0fx0JoGAJ4U44yceOXKFej9MYZC+4GMAxmctvTBt/sgywS/f3IdBIG3aCTHcVF91uedd94pMVtyPTLmwOSbTL/AOx0NZOtrUqoYYnVzXJ8tRzoKsLomgtKyCGpr7wEAeL1qVHH+/C3cjiS5cf2GZpSXl2iauHDhQgiCgHPnzkGfCP1i8DgUJUkxpZ565JORMnMgA+NCM+5ftQEKBXheVaq3/noahFA89fQ68DyPHTt2mH8i6V6S0t3dbVhs5is3v5ScudFZi4sL44NkwpH64Za7tbW1/TMYDK7YuXOnMG/ePI6ptN/vhyiKli3CIotTJ0cQDsdw48YQEokY/rBjM6qqKi3L3bt3LyYmJjQhv/DCCwgEkqn/PXv+jOnpaS0UXLNmDTwej20kojcOqR5YLxgAWhb7zTffhCRJ6OraBlEUtZDzyggPRQHuXUSR6lZ6PlQUBfv27TNYaNEpz5eJH5aOh8zXeZ4zzaNqJOMl8/hUbfP904HNRSkFpaqQ9I/k9Hz6tSqKYsmA227hqan0yd3qmgjKvLdRW6tGDmVlqmVlMbL5MOnFF19EIBBAMBg0cNbLL78MSileffVVhMNhEHkBZMmHr66yEY0AoGvnhoceVLnt2ldGgZ0Z+AsoJejrz+2++Z8nZGFwU1lo1ldsy51uq+eTNbIV4MULtzAzI2NqahyyLGPduntRUZn0/4hcD1mSMTk5DkJkyLJx+7/22msYGxvDc889h2AwiKqqqpTWkh1MvfTSS6CUYs+ePQiHf8CSlo1wuaz+ZqHBhNfT0+OllGbtkNoKMGlh1TdkfUfps86KooBSaolF7cDGqPPZ+q1Fg6IosqL3rzKE7ZNNTY1jfPy/uHr1c4yMXEI8HjVcn5wcm73+GUZGLiGRiOWw7J8+nFXj/0gL2y1cVR2BpzSCubV3AwC8XmPVGbPCc2cjFGaFGZ5//nkQQvD6669jYmJi1v9TrbB+S09MTIBSit27dyMcDmP1A0+jpMSLixcHkEjknKbLGIwDt2zZEsnl95mcyuV0ned5jQcppY6Wjo1VLTKft3XMFrlWONj+6OGHHzZYTSYo5t8RuWHWCo8ZrDCLhc3Yu3cvgKQ/yLB7925MT09rwmpsovB6CUTxEcgy0NhIIOhWaT4TYTCfjZjxxhtvQJIkbN++HaKYm/c2G4kY+tLeqZC+mZ022WsaxxZhiRxS+Y52/Za7Fj6DzgkAuFAodD4YDC7fuXMn6urqHH/oFAuziOTs2bOIRqPo71NP5eKJbwzZmCeeeAI+n09r19XVQRAELXY+d3YMiQRFYxOBIECLjdva2uB2uzE0NARCCEZHR0EpRXt7O1wuFwYHB0Ep1TLSW7duhcvlsrhUb7+lZmOefGpdSndr//79+hesHDx40ED2oqIoBEjGitnCiauSb1z9U/kwOY99DM7ub8z2sPnMmmTuZ9fYc9nNY84PWq8b+dvsKzqSgd2ZiFMsPDIygkQiYclKL2n5NVyu5Ev85t8+8LyAxiaCVNS06gG1rO3sx6omNi1sgCAAp06dAiEE7e3tcLvdEAQBhBCcOHEClFI0NDSkFNjbb6kZ6SefUjPSq1a1QVEAjlNf6v79+w2K1N3d7covI+2U98uaTrKrm7GjKzvNzzY75JQfVBSF5iVAuzORFStWGMaxLAs7H7Z7CPOp3MWLlyFJFJL0K7jdHsjy9xBFtWRY7wXoNVGSKBY01kMQgJMnTxq4j+d5EEJsDcX9928A1WWkzwzsAyEE/WfU693d3aX6U7l0wgPyOBMpVHZDi7UdMttmTuRmrXMq7ktrZU1WXVHo7J+2nqxiYk2AJ06c+AUATE1NXQoEAsueffZZ1NXV2Z6JMDjVyJhhdyrnD4yhtNSNG9drQCmvaWJtba2Byx5YrWrixx+pmti08GcQBFi4j9XGsMoEJtSBgX2QZVnL//X09JTpKxOcNM5WgOyHthr0o9R/WpEpJzpZa107Lcc5wXELL1++3NBmi2Ga58R5ZthVJgSDQXi9HvD8LVBKMXpD1UQifwchnSZ+PAZZomhsagDPW6nlwIEDhnZPT0+lLMtadVYuKSw98o6FixWzapbfdl1sIONOLqV2mn3bXPN+drBMyY7xQqHQp7MVqjBXqKbjvBvXBSQS0PxGViPN6gMbG5ca/MBr1/4FSUrgj3/aAb+/HMPDw5AkScvSTE6omti0UI1EzJrI3t1HH96ELNsfPg38Yz8IkTSq6u3t9RJC8k5iWjRQx4XKncyG5Aq7DWK3czKp984Gtlv4vffeWwmAm56e/iQQCCxl/Z2dnQgGg5Y3/LdjapV+Q0ML3O4S2xppOw48deoUSkpErF+/Hh6PR/suhHEis86EfJdSE1e3zkn5HB9+cBOEJNd6+fJlUErx2GOP/cDzfPHqA1mMzPJ0uv6UnGeNKXPzB+38uEz9xCzmKUidoKMReffdd5cBQCgU+szv9y+xG7e5Q63SP3pE/VKp47fql0qskoHBzg+sr6+H1+tBX18fCCHYsGEDPB6PVhfINPH6NaMmOkFRMhiUBxwFmKmPpL3N5HcbOefdfgrcy5BxKDeriVw4HP7M7/cv7uzsNGSWGTbPfi/Cal3MsOPARYsWwe8vhyiKkCTJoIklJSUWTrx+rQaK4mwPzO9i2bJlAIBDhw6VE0JiRfcDkwvROFFJd8ZhJzgnmGNZR05EbhWzuuKkgviDWR8OHD9+/D4ACIfDX+g/uH788cdTfnBthh0HMivMuE8URciyjNOnT6vZkv7+lBWvmaK3t7dClmXt5C2f8E2PrAXoGDPnCKf8Xr7z5Rvz2iHn4qLjx48vhS6SmZmZGayoqPi5eVwoFDKcedhx4Pz58+H1evDKK68gEkke0TKhHT169K5YLHYz1/UWMnzTI2cBMk5koJQquZypMDCuszubKXQMWygULEllFyJt2rTpqs/nW+C0/Ri5Hzt27J5oNPqt+Xoxtl8hULD/N2D3gJlyFxtTLK4qFv4HKDK+4HhuBCkAAAAASUVORK5CYII="

  // --- PLANETA DE FONDO (fijo, difuso) ---
  const bgPlanetImg = new Image();
  bgPlanetImg.decoding = "async";
  let bgPlanetReady = false;
  bgPlanetImg.onload = () => { bgPlanetReady = true; };
  bgPlanetImg.src = "data:image/png;base64,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JBCToqcc2XfVPL9UzgZcNDf6ika/15BmA7LggLfsrCPv0plz6vKdQuTC5mSSxvER/eLXLyda69vA19Y1U+O7uxlNbIBB3DrR3QIuAu+v58b/vXLhjooLah5TI81NtVhQz1PZtb0jPapKc0stjY01ADpxyljOu+gjhMMNiFh++OWr3veV7zQGud3ob2OV0lTt0c369/9a9+ImAMft87yPLOgqfJgJrF3zACds0nGRWsexidwNDDHWPeWO1duoQnikqo6sAspRxzUwbVbB9uBA0IbmGsZOmEUkOq6a7ak2FA11K1PAV6BuVZqAyom1oz1G5954elTOfovasbePjjZfMy0SdkD9kUwVNjzXvi6ucyqTTQVgIE/F/Tfps7uk/h9PrNoGcBZw7qduLlLgas6AblgZnFwl7qYCYk2LIIoLh4dhfhpVfHAOUUm2Pe4gyio60tjAU0rtYQ3KX1fuTyG1czpKOeeyiHXtW449JJqQwwBMhHBjkkDZmUWc3/3pT87dQmcljZgdYvcRH/n3OJGUfdvqJ//Bz/57MZ6r7uP3tfcqP6ikvFGBv/95x93rXwxUMrng8Nk9csmCKQB0dyaX/+rnHa2e36cXHju3lze8fXJBJlXDv/77655+5eWl/k9VEZH0MffW/jTwTcPLSWP39th312yb0KcSElV7Qp32XPzYRw6HKBDHPwLEuez7v6r7RzeBM2EbTOhTaQGwYdN7zilj/kgVXGyWRaw1ao6dYHi3AuIW11tQVH64lzMrbUSLoefeRDxGna885V562k3RNfza6mheaQ2M69a+OP76Lk4PSntp3UuPfTIl2ZRXNva+vo3XtluaREV3Pb3+4Q+8oUihp573br3tiXenf2reMRta5HzAtHh8D7/52TW07e7xL1x5vMjEgretnqezldBEwwlBzezx5MQe0WNFAddu2/5K121TOMYMdYOhBDH4U7/LwB1zENWBjkLxnwYAVVVHTNoALP+PlN2iv2uQFl0N3et28ZH16+eGeKVLeaExFLLlB5IQ/19/p2d76suy2xQBk1KfCqND8MH6aka26EtLu3ktCethLdgAiZqqEo64AKJqv+qpSWjeAib1nj1IYBzXX8SZqomugon1vHNDL17QelWdoZFIXJuEGii9Q2UVs8byZg9qcxNAEO9oo4sjQp8Cy8+ctZQ7V38fEYOIEK0ZU62HelUg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"
	
	let falconReady = false;
	falconImg.onload = () => { falconReady = true; };

  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  const scoreEl = document.getElementById("score");
  const bestEl  = document.getElementById("best");

  const W = canvas.width, H = canvas.height;
  
	  // --- FX: explosi√≥n + shake ---
	const particles = [];
	let shakeT = 0;
	let shakeAmp = 0;
	let flashT = 0;
	let canRestart = true;
	let restartTimer = 0;
	// --- Fases / avisos en pantalla ---
	let phaseMsg = "";
	let phaseT = 0;
	let phaseDur = 0;
	let phase2Shown = false;

	function showPhase(msg, dur=2.6){
		phaseMsg = msg;
		phaseDur = dur;
		phaseT = dur;
	}



  
 
/// --- Planeta / suelo recto pero rocoso ---
const GROUND_Y = H - 34;     // altura del suelo (sube/baja)
const ROCK_AMP = 7;          // ‚Äúrugosidad‚Äù del borde (3‚Äì10)
const ROCK_STEP = 12;        // anchura de ‚Äúpiedras‚Äù (8‚Äì18)


const TIE_UNLOCK_DIST = 6000; // px de worldX; ajusta (4000‚Äì9000)

// borde rocoso determinista (no aleatorio cada frame)
function rockEdgeAt(ix){
  // ix es un √≠ndice de segmento
  // combinaci√≥n simple de senos -> irregular, estable y barata
  return (
    Math.sin(ix * 1.7 + 0.9) * 0.55 +
    Math.sin(ix * 0.73 + 2.1) * 0.35 +
    Math.sin(ix * 0.31 + 0.2) * 0.20
  ) * ROCK_AMP;
}

function groundY(x){
  const ix = Math.floor((x + worldX*0.60) / ROCK_STEP);  //0.35 es la velocidad del suelo
  // ‚Äúsnap‚Äù por segmentos para que parezca roca/p√≠xel, no ola suave
  return GROUND_Y + rockEdgeAt(ix);
}

// --- Suelo estilo meteorito: textura tileable con cr√°teres (pixel art) ---
let groundTile = null;
let groundPattern = null;
const GROUND_TILE_W = 512;
const GROUND_TILE_H = 220;

// paleta (misma familia que meteoritos)
const G = {
  deep: "#0b1020",
  base: "#2a3242",
  mid:  "#3b4558",
  hi:   "#5f6878"
};

const laserPool = Array.from({length: 5}, () => {
  const a = new Audio("audio/8-bit-laser.mp3");
  a.volume = 0.6;
  return a;
});
let laserIdx = 0;

let lastLaserSfx = 0;

function playLaser(){
  if (!audioUnlocked || !audioEnabled) return;

  const now = performance.now();
  if (now - lastLaserSfx < 120) return;
  lastLaserSfx = now;

  if (laserCtx && laserBuf){
    const src = laserCtx.createBufferSource();
    src.buffer = laserBuf;
    src.connect(laserGain);
    src.start(0);
    return;
  }

  // fallback
  const a = laserPool[laserIdx];
  laserIdx = (laserIdx + 1) % laserPool.length;
  a.currentTime = 0;
  a.play().catch(()=>{});
}

function playCrash(){
  if (!audioUnlocked || !audioEnabled) return;

  if (laserCtx && crashBuf){
    const src = laserCtx.createBufferSource();
    src.buffer = crashBuf;
    src.connect(sfxGain);
    src.start(0);
    return;
  }

  // fallback por si a√∫n no carg√≥
  sfxCrash.currentTime = 0;
  sfxCrash.play().catch(()=>{});
}



function buildGroundTile(){
  groundTile = document.createElement("canvas");
  groundTile.width = GROUND_TILE_W;
  groundTile.height = GROUND_TILE_H;
  const g = groundTile.getContext("2d");
  g.imageSmoothingEnabled = false;

  // base
  g.fillStyle = G.base;
  g.fillRect(0,0,GROUND_TILE_W,GROUND_TILE_H);

  // helper: dibuja tambi√©n copias en bordes para que el tile ‚Äúcase‚Äù
  const PAD = 28;
  function wrapDraw(drawFn, x, y, a){
    drawFn(x, y, a);
    if (x < PAD) drawFn(x + GROUND_TILE_W, y, a);
    if (x > GROUND_TILE_W - PAD) drawFn(x - GROUND_TILE_W, y, a);
    if (y < PAD) drawFn(x, y + GROUND_TILE_H, a);
    if (y > GROUND_TILE_H - PAD) drawFn(x, y - GROUND_TILE_H, a);

    // esquinas
    if (x < PAD && y < PAD) drawFn(x + GROUND_TILE_W, y + GROUND_TILE_H, a);
    if (x < PAD && y > GROUND_TILE_H - PAD) drawFn(x + GROUND_TILE_W, y - GROUND_TILE_H, a);
    if (x > GROUND_TILE_W - PAD && y < PAD) drawFn(x - GROUND_TILE_W, y + GROUND_TILE_H, a);
    if (x > GROUND_TILE_W - PAD && y > GROUND_TILE_H - PAD) drawFn(x - GROUND_TILE_W, y - GROUND_TILE_H, a);
  }

  // dithering / ruido pixel (seamless)
  sprinkleNoise(g, GROUND_TILE_W, GROUND_TILE_H, G.mid, 0.060, PAD);
  sprinkleNoise(g, GROUND_TILE_W, GROUND_TILE_H, G.deep, 0.040, PAD);

  // micro-variaci√≥n vertical MUY sutil (evita bandas duras)
  g.globalAlpha = 0.08;
  g.fillStyle = "#000";
  g.fillRect(0, (GROUND_TILE_H*0.62)|0, GROUND_TILE_W, (GROUND_TILE_H*0.38)|0);
  g.globalAlpha = 1;

  // cr√°teres (algunos cruzan borde para continuidad)
  for (let i=0;i<18;i++){
    const x = (Math.random()*GROUND_TILE_W)|0;
    const y = ((Math.random()*GROUND_TILE_H*0.88)+8)|0;
    const r = (10 + Math.random()*34)|0;
    wrapDraw((xx,yy,rr)=>drawCrater(g, xx, yy, rr), x, y, r);
  }

  // rocas / aristas peque√±as (seamless)
  for (let i=0;i<56;i++){
    const x = (Math.random()*GROUND_TILE_W)|0;
    const y = (Math.random()*GROUND_TILE_H)|0;
    const s = 2 + (Math.random()*5)|0;
    wrapDraw((xx,yy,ss)=>drawRock(g, xx, yy, ss), x, y, s);
  }

  // patr√≥n repetible
  groundPattern = ctx.createPattern(groundTile, "repeat");
}

function sprinkleNoise(g, w, h, col, density, pad=0){
  g.fillStyle = col;
  const n = (w*h*density)|0;
  for (let i=0;i<n;i++){
    const x = (Math.random()*w)|0;
    const y = (Math.random()*h)|0;
    g.fillRect(x,y,1,1);

    // si queremos tile seamless, duplica puntos cerca de bordes
    if (pad){
      if (x < pad) g.fillRect(x+w, y, 1, 1);
      if (x >= w-pad) g.fillRect(x-w, y, 1, 1);
      if (y < pad) g.fillRect(x, y+h, 1, 1);
      if (y >= h-pad) g.fillRect(x, y-h, 1, 1);

      if (x < pad && y < pad) g.fillRect(x+w, y+h, 1, 1);
      if (x < pad && y >= h-pad) g.fillRect(x+w, y-h, 1, 1);
      if (x >= w-pad && y < pad) g.fillRect(x-w, y+h, 1, 1);
      if (x >= w-pad && y >= h-pad) g.fillRect(x-w, y-h, 1, 1);
    }
  }
}

function drawPixelLine(g, x1,y1,x2,y2, col){
  g.fillStyle = col;
  x1|=0; y1|=0; x2|=0; y2|=0;
  let dx = Math.abs(x2-x1), sx = x1<x2?1:-1;
  let dy = -Math.abs(y2-y1), sy = y1<y2?1:-1;
  let err = dx + dy;
  while(true){
    g.fillRect(x1,y1,1,1);
    if (x1===x2 && y1===y2) break;
    const e2 = 2*err;
    if (e2 >= dy){ err += dy; x1 += sx; }
    if (e2 <= dx){ err += dx; y1 += sy; }
  }
}

function hash1(n){
  // hash entero simple (determinista)
  n = (n|0) ^ 0x9e3779b9;
  n = (n ^ (n >>> 16)) * 0x7feb352d;
  n = (n ^ (n >>> 15)) * 0x846ca68b;
  return (n ^ (n >>> 16)) >>> 0;
}

function fillCirclePx(g, cx, cy, r, col){
  g.fillStyle = col;
  r |= 0;
  for (let dy = -r; dy <= r; dy++){
    const yy = (cy + dy) | 0;
    const dx = (Math.sqrt(r*r - dy*dy) | 0);
    const xx = (cx - dx) | 0;
    g.fillRect(xx, yy, (dx*2 + 1)|0, 1);
  }
}

function fillCirclePxJitter(g, cx, cy, r, col, seed){
  // igual que fillCirclePx pero con borde ‚Äúdentado‚Äù (pixel art)
  g.fillStyle = col;
  r |= 0;
  for (let dy = -r; dy <= r; dy++){
    const yy = (cy + dy) | 0;
    const h = hash1((yy + seed*131) | 0);
    const j = ((h % 3) - 1); // -1..+1
    const rr = Math.max(2, r + j);
    const dx = (Math.sqrt(rr*rr - dy*dy) | 0);
    const xx = (cx - dx) | 0;
    g.fillRect(xx, yy, (dx*2 + 1)|0, 1);
  }
}

function drawCrater(g, x, y, r){
  // Cr√°ter ‚Äúpixel art‚Äù: borde dentado + interior con sombra y highlight.
  // Evita c√≠rculos suaves y negros puros.
  const seed = hash1(((x|0) * 73856093) ^ ((y|0) * 19349663)) | 0;

  // borde exterior (dentado)
  fillCirclePxJitter(g, x, y, r, G.deep, seed);

  // interior
  fillCirclePx(g, x, y, Math.max(2, (r*0.78)|0), G.mid);

  // sombra interior abajo-dcha (una ‚Äúmedia luna‚Äù pixelada)
  fillCirclePx(g, x + ((r*0.18)|0), y + ((r*0.18)|0), Math.max(2, (r*0.55)|0), G.base);

  // highlight arriba-izq (bisel)
  fillCirclePx(g, x - ((r*0.20)|0), y - ((r*0.20)|0), Math.max(2, (r*0.18)|0), G.hi);

  // grietas pixeleadas (en tonos del suelo, no negro puro)
  const crackCol = "rgba(11,16,32,.28)";
  for (let k=0;k<3;k++){
    const ang = ((hash1(seed + k*17) % 6283) / 1000); // 0..~6.283
    const len = (r*0.55 + (hash1(seed + k*97) % (r*55))/100)|0;
    const x2 = x + Math.cos(ang)*len;
    const y2 = y + Math.sin(ang)*len;
    drawPixelLine(g, x, y, x2, y2, crackCol);
  }

  // ‚Äúchips‚Äù en el borde (peque√±os pixels de highlight)
  g.fillStyle = "rgba(255,255,255,.10)";
  const chips = 2 + (seed % 3);
  for (let i=0;i<chips;i++){
    const ang = ((hash1(seed + i*101) % 6283) / 1000);
    const rr = (r*0.85)|0;
    const px = (x + Math.cos(ang)*rr)|0;
    const py = (y + Math.sin(ang)*rr)|0;
    g.fillRect(px, py, 1, 1);
  }
}

function drawRock(g, x, y, s){
  g.fillStyle = "rgba(0,0,0,.20)";
  g.fillRect(x, y, s, s);
  g.fillStyle = "rgba(255,255,255,.08)";
  g.fillRect(x+1, y+1, Math.max(1,s-2), Math.max(1,s-2));
  g.fillStyle = "rgba(255,255,255,.16)";
  g.fillRect(x+1, y+1, 1, 1);
}




function drawPlanetSurface(){
  // Asegura tile creado
  if (!groundPattern) buildGroundTile();

  // Silueta del suelo (usa tu groundY para que coincida con colisi√≥n)
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(0, H);
  ctx.lineTo(0, groundY(0));
  for (let x = 0; x <= W; x += 6){
    ctx.lineTo(x, groundY(x));
  }
  ctx.lineTo(W, H);
  ctx.closePath();

  // Base (oscura) para dar profundidad
  ctx.fillStyle = G.deep;
  ctx.fill();

  // Clip al suelo y rellena con textura que ‚Äúcorre‚Äù con el mundo
  ctx.save();
  ctx.clip();

  // scroll suave: mismo factor que groundY (worldX*0.60)
  const offX = ((worldX*0.60) % GROUND_TILE_W);
  ctx.translate(-(offX|0), 0);

  ctx.fillStyle = groundPattern;
  // pintamos algo m√°s ancho por el translate
  ctx.fillRect(-GROUND_TILE_W, 0, W + GROUND_TILE_W*3, H);

  ctx.restore(); // clip

  // Borde superior (arista) + highlight, estilo meteorito
  ctx.globalAlpha = 0.95;
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(150,160,178,.38)";
  ctx.beginPath();
  ctx.moveTo(0, groundY(0));
  for (let x = 0; x <= W; x += 6){
    ctx.lineTo(x, groundY(x));
  }
  ctx.stroke();

  // finita sombra justo debajo del borde (da relieve)
  ctx.globalAlpha = 0.35;
  ctx.strokeStyle = "rgba(0,0,0,.25)";
  ctx.beginPath();
  ctx.moveTo(0, groundY(0)+2);
  for (let x = 0; x <= W; x += 6){
    ctx.lineTo(x, groundY(x)+2);
  }
  ctx.stroke();
  ctx.globalAlpha = 1;

  ctx.restore();
}


// --- Estrellas (2 capas, m√°s aleatorias) ---
let starsFar = [];
let starsNear = [];

function initStars(){
  const rand = (a,b)=>a + Math.random()*(b-a);
  const mk = (n, sizeMin, sizeMax, hueChance)=>{
    const arr = [];
    for (let i=0;i<n;i++){
      // x en espacio "infinito" (se envuelve con worldX)
      const x = rand(0, W);
      const y = rand(0, H);
      const r = rand(sizeMin, sizeMax);
      const tw = rand(0, Math.PI*2);   // fase de twinkle
      const sp = rand(0.75, 1.35);     // variaci√≥n por estrella
      const tint = (Math.random() < hueChance) ? 1 : 0;
      arr.push({x,y,r,tw,sp,tint});
    }
    return arr;
  };
  // far: m√°s peque√±as y m√°s densas
  starsFar  = mk(220, 0.7, 1.8, 0.07);
  // near: menos densas, algunas m√°s grandes
  starsNear = mk(120, 1.0, 2.7, 0.12);
}

  // F√≠sica tipo "flappy en horizontal"
  const gravity = 1500;        // px/s^2  //2200
  const thrustV = 500;         // px/s (impulso arriba)  //660
  let worldSpeed = 360;        // px/s scroll

  // Halc√≥n
  const ship = {
    x: 210,
    y: H * 0.48,
    vy: 0,
    rot: 0,         // rotaci√≥n visual
    animT: 0,
    engineFlash: 0,
    r: 18           // radio aproximado para colisi√≥n (m√°s justo)
  };

  // Entidades
  const asteroids = [];
  const ties = [];
  const lasers = []; // disparos enemigos

  // Spawns
  let tAst = 0, nextAst = 0.8;
  let tTie = 0, nextTie = 2.2;
  let bigAstCooldown = 0; // evita meteoritos grandes seguidos (segundos)

  // Fondo
  let worldX = 0;

  // Estado
  let running = false;
  let gameOver = false;
  let score = 0;
  let best = Number(localStorage.getItem("falcon_run_best") || 0);
  bestEl.textContent = best;

  const SPR = makeSprites();

  let lastT = performance.now();

  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// RNG determinista (para sprites reproducibles)
	function mulberry32(seed){
	  let t = seed >>> 0;
	  return function(){
		t += 0x6D2B79F5;
		let x = Math.imul(t ^ (t >>> 15), 1 | t);
		x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
		return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
	  };
	}
  function reset(){
    running = true;
    gameOver = false;
    score = 0;
    scoreEl.textContent = "0";

    worldSpeed = 360;

    ship.y = H * 0.48;
    ship.vy = 0;
    ship.rot = 0;
    ship.animT = 0;

    asteroids.length = 0;
    ties.length = 0;
    lasers.length = 0;

    tAst = 0; nextAst = rand(0.65, 0.95);
    tTie = 0; nextTie = rand(1.9, 2.6);

    worldX = 0;
    if (!starsFar.length) initStars();
    if (!groundPattern) buildGroundTile();
	 // ‚úÖ limpiar FX
	  particles.length = 0;
	  shakeT = 0;
	  shakeAmp = 0;
	  flashT = 0;
	  // Fases
	  phase2Shown = false;
	  showPhase("FASE 1 ¬∑ Campo de asteroides", 2.6);
	  tAst = -phaseDur;   // espera hasta que termine el cartel de FASE 1

	  
	  if (audioEnabled){
		  musicStarted = true;
		  startMusic();
		} else {
		  musicStarted = false;
		  stopMusic();
		}

	  
  }

  function thrust(){
    if (!running) reset();
    if (gameOver && canRestart) { reset(); return; }
    ship.vy = -thrustV;
    ship.engineFlash = 15;
  }

window.addEventListener("keydown", (e) => {
  if (e.code === "Space") {
	e.preventDefault();
	
	unlockAudio().then(() => {
    if (!musicStarted && !gameOver) {
      startMusic();
      musicStarted = true;
    }
	});
	thrust();
   }

  if (e.code === "KeyR") {
	e.preventDefault();
	reset();
  }
}, { passive:false });

canvas.addEventListener("pointerdown", () => {
  unlockAudio().then(() => {
    if (!musicStarted && !gameOver) {
      startMusic();
      musicStarted = true;
    }
  });
  thrust();
});


  // --- Spawns ---
  function spawnAsteroid(){
    // Algunos meteoritos mucho m√°s grandes (raros)
    let sizeType = 'normal';
    const roll = Math.random();
    if (roll < 0.03) sizeType = 'huge';
    else if (roll < 0.18) sizeType = 'big';

    // Evita encadenar grandes
    if (sizeType !== 'normal' && bigAstCooldown > 0) sizeType = 'normal';

    let r, speedMul, spinMul, hitMul;
    if (sizeType === 'huge'){
      r = rand(52, 70);
      speedMul = 0.72;
      spinMul = 0.55;
      hitMul = 0.86;
    } else if (sizeType === 'big'){
      r = rand(36, 48);
      speedMul = 0.84;
      spinMul = 0.75;
      hitMul = 0.88;
    } else {
      r = rand(16, 32);
      speedMul = 1.00;
      spinMul = 1.00;
      hitMul = 0.92;
    }

    if (sizeType !== 'normal') bigAstCooldown = 2.4;

    const y = rand(r+20, H - (r+20));

    // rotaci√≥n y forma (elige sprite de 2 variantes)
    const variant = (Math.random() < 0.5) ? 0 : 1;
    const spin = rand(-2.2, 2.2) * spinMul;

    asteroids.push({
      x: W + 80,
      y,
      r,
      hitR: r * hitMul,
      sizeType,
      variant,
      a: rand(0, Math.PI*2),
      spin,
      vx: worldSpeed * speedMul * rand(0.95, 1.25)
    });
  }

  function spawnTIE(){
    const y = rand(70, H-70);
    const w = 66, h = 44;
    ties.push({
      x: W + 100,
      y,
      w, h,
      vx: worldSpeed * rand(0.90, 1.10),
      shootT: 0,
      nextShoot: rand(0.65, 1.25), // frecuencia de disparo
      anim: rand(0,100),
      passed: false
    });
  }

  // --- Colisiones ---
  function circleHit(ax, ay, ar, bx, by, br){
    const dx = ax - bx, dy = ay - by;
    return (dx*dx + dy*dy) <= (ar+br)*(ar+br);
  }

  function aabb(a,b){
    return a.x < b.x + b.w &&
           a.x + a.w > b.x &&
           a.y < b.y + b.h &&
           a.y + a.h > b.y;
  }
	
function spawnExplosion(x, y){
  // chispas (r√°pidas)
  for (let i=0; i<26; i++){
    const a = rand(0, Math.PI*2);
    const sp = rand(220, 520);
    particles.push({
      x, y,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      life: rand(0.25, 0.55),
      r: rand(1.2, 2.4),
      type: "spark"
    });
  }
  // humo (lento)
  for (let i=0; i<14; i++){
    const a = rand(0, Math.PI*2);
    const sp = rand(40, 140);
    particles.push({
      x: x + rand(-6, 6),
      y: y + rand(-6, 6),
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      life: rand(0.55, 1.10),
      r: rand(4, 9),
      type: "smoke"
    });
  }

  // shake + flash
  shakeT = 0.18;
  shakeAmp = 10;
  flashT = 0.10;
}

function updateParticles(dt){
  for (let i=particles.length-1; i>=0; i--){
    const p = particles[i];
    p.life -= dt;
    if (p.life <= 0){ particles.splice(i,1); continue; }

    // f√≠sica simple
    if (p.type === "spark"){
      p.vy += 900 * dt;          // gravedad a chispas
      p.vx *= Math.pow(0.20, dt); // freno
      p.vy *= Math.pow(0.25, dt);
    } else {
      p.vx *= Math.pow(0.45, dt);
      p.vy *= Math.pow(0.45, dt);
    }

    p.x += p.vx * dt;
    p.y += p.vy * dt;
  }

  if (shakeT > 0) shakeT = Math.max(0, shakeT - dt);
  if (flashT > 0) flashT = Math.max(0, flashT - dt);
}

function drawParticles(){
  ctx.save();
  ctx.globalCompositeOperation = "lighter";

  for (const p of particles){
    const t = Math.max(0, Math.min(1, p.life)); // solo para modulaci√≥n simple
    if (p.type === "spark"){
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = "rgba(255,200,120,1)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 0.35;
      ctx.fillStyle = "rgba(255,80,60,1)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r*1.8, 0, Math.PI*2);
      ctx.fill();
    } else {
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = "rgba(80,90,110,1)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }
  }

  ctx.restore();

  // flash blanco breve
  if (flashT > 0){
    ctx.save();
    ctx.globalAlpha = (flashT / 0.10) * 0.35;
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);
    ctx.restore();
  }
}


function unlockAudio(){
  if (audioUnlocked) return Promise.resolve();
  if (audioUnlockPromise) return audioUnlockPromise;

  audioUnlocked = true;

  audioUnlockPromise = music.play().then(() => {
    // Pausar si no toca m√∫sica
    if (!musicStarted || !audioEnabled){
      music.pause();
      music.currentTime = 0;
    }

    // üî• Precalentar FX HTMLAudio
    laserPool.forEach(a => {
      try { a.load(); } catch(e){}
    });
    try { sfxCrash.load(); } catch(e){}

    // üî•üî• AQU√ç VA EL PUNTO 3) üî•üî•
    initLaserWebAudio().then(() => {
      if (laserCtx && laserCtx.state === "suspended") {
        laserCtx.resume().catch(()=>{});
      }
    });

  }).catch(() => {});

  return audioUnlockPromise;
}




  function crash(){
    if (gameOver) return;
	
	playCrash();
	stopMusic();
	
	spawnExplosion(ship.x, ship.y);
    gameOver = true;
	phaseT = 0;
	phaseMsg = "";
    const s = Math.floor(score);
    if (s > best){
      best = s;
      localStorage.setItem("falcon_run_best", String(best));
      bestEl.textContent = String(best);
    }
	canRestart = false;
	restartTimer = 1.2;   // segundos que debe verse la explosi√≥n

  }

  function update(dt){
	//updateParticles(dt);
	// timer avisos de fase
	if (phaseT > 0) phaseT = Math.max(0, phaseT - dt);
    if (!running) return;

    // Dificultad suave
    worldSpeed = 360 + Math.min(420, score * 7);
    const astRate = (score > 18) ? 0.90 : 1.0; // un pel√≠n m√°s denso con score
    const tieRate = (score > 25) ? 0.92 : 1.0;

    worldX += worldSpeed * dt;
    bigAstCooldown = Math.max(0, bigAstCooldown - dt);

    // F√≠sica nave
    ship.vy += gravity * dt;
    ship.y  += ship.vy * dt;
    // --- ROTACI√ìN: solo hacia arriba y vuelta suave a horizontal ---
	const maxUp = 0.45;                 // rad (~26¬∞) m√°ximo hacia arriba
	const targetRot = (ship.vy < -40) ? -maxUp : 0; // subiendo -> inclina arriba, si no -> 0

	// velocidad de giro distinta seg√∫n direcci√≥n (subida lenta, retorno m√°s r√°pido)
	const upRate = 3.0;    // m√°s bajo = m√°s lento al subir
	const downRate = 8.0;  // m√°s alto = vuelve m√°s r√°pido a horizontal

	const rate = (targetRot < ship.rot) ? upRate : downRate; // si vamos hacia arriba, usa upRate
	const smooth = 1 - Math.exp(-rate * dt);

	ship.rot += (targetRot - ship.rot) * smooth;

	// Seguridad: nunca nose-down
	if (ship.rot > 0) ship.rot = 0;


    // techo
	if (ship.y - ship.r < 0){
	  crash(); return;
	}

		// suelo rocoso (recto con borde irregular)
	if (ship.y + ship.r > groundY(ship.x)){
	  crash(); return;
	}


    // Spawns
    tAst += dt;
    if (tAst >= nextAst){
      tAst = 0;
      nextAst = rand(0.55, 0.95) * (worldSpeed > 650 ? 0.92 : 1) * astRate;
      spawnAsteroid();
    }

    
	// Aviso de FASE 2 al desbloquear TIE (sin pausar)
	if (!phase2Shown && worldX >= TIE_UNLOCK_DIST){
		phase2Shown = true;
		showPhase("FASE 2 ¬∑ ¬°Peligro! TIE Fighters", 2.8);
	}

// Solo aparecen TIE cuando has avanzado suficiente
	if (worldX >= TIE_UNLOCK_DIST){
	  tTie += dt;
	  if (tTie >= nextTie){
		tTie = 0;
		nextTie = rand(1.7, 2.6) * (worldSpeed > 650 ? 0.95 : 1) * tieRate;
		spawnTIE();
	  }
	} else {
	  // mientras tanto, no acumules timer para que no spawnee uno ‚Äúinstant√°neo‚Äù al desbloquear
	  tTie = 0;
	}


    // Mover asteroides
    for (let i=asteroids.length-1;i>=0;i--){
      const a = asteroids[i];
      a.x -= a.vx * dt;
      a.a += a.spin * dt;

      // score por "pasar"
      if (a.x + a.r < ship.x - 40 && !a.passed){
        a.passed = true;
        score += 0.25;
      }

      if (a.x + a.r < -120) asteroids.splice(i,1);
    }

    // Mover TIE + disparar
    for (let i=ties.length-1;i>=0;i--){
      const t = ties[i];
      t.x -= t.vx * dt;

      // score por esquivar TIE (cuando pasa)
      if (!t.passed && t.x + t.w < ship.x - 10){
        t.passed = true;
        score += 1;
        scoreEl.textContent = String(Math.floor(score));
      }

      // disparos
      t.shootT += dt;
      if (!gameOver && t.shootT >= t.nextShoot && t.x < W - 60){
        t.shootT = 0;
        t.nextShoot = rand(0.60, 1.15) * (score > 20 ? 0.90 : 1);

        // l√°ser hacia la izquierda (ligero spread vertical hacia el Halc√≥n)
        const vx = -(worldSpeed * 1.85);  // M√ÅS r√°pido
		const vy = 0;                     // SIN diagonal (recto)

		// dispara desde el ‚Äúfrente‚Äù del TIE (lado izquierdo del sprite)
		lasers.push({
		  x: t.x,
		  y: t.y,
		  vx, vy,
		  w: 22,   // un pel√≠n m√°s largo
		  h: 4,
		  life: 2.0
		});
		
		playLaser();

      }

      if (t.x + t.w < -180) ties.splice(i,1);
    }

    // Mover l√°seres
    for (let i=lasers.length-1;i>=0;i--){
      const l = lasers[i];
      l.x += l.vx * dt;
      l.y += l.vy * dt;
      l.life -= dt;

      // fuera
      if (l.life <= 0 || l.x < -200 || l.y < -60 || l.y > H+60) {
        lasers.splice(i,1);
        continue;
      }

      // colisi√≥n l√°ser vs nave (AABB contra una caja del halc√≥n)
      const shipBox = { x: ship.x-20, y: ship.y-14, w: 40, h: 28 };
      const laserBox = { x: l.x, y: l.y - (l.h/2), w: l.w, h: l.h };
      if (aabb(shipBox, laserBox)) { crash(); return; }
    }

    // Colisi√≥n nave vs asteroides (c√≠rculo)
    for (const a of asteroids){
      if (circleHit(ship.x, ship.y, ship.r, a.x, a.y, (a.hitR ?? (a.r*0.92)))){
        crash(); return;
      }
    }

    // Colisi√≥n nave vs TIE (hitbox ajustada)
    const shipHit = { x: ship.x-18, y: ship.y-12, w: 36, h: 24 };
    for (const t of ties){
      const tieHit = { x: t.x+14, y: t.y-(t.h/2)+10, w: t.w-28, h: t.h-20 };
      if (aabb(shipHit, tieHit)) { crash(); return; }
    }

    // actualizar score mostrado aunque sumemos fracciones por asteroides
    scoreEl.textContent = String(Math.floor(score));
	
	// Motor: flash instant√°neo (solo 1 frame)
	// Motor: flash 1-frame visible (update va antes que draw)
	if (ship.engineFlash > 0) ship.engineFlash--;
	

  }

  // --- Dibujo ---
  
 function drawBgPlanet(){
  if (!bgPlanetReady) return;

  const targetW = W * 0.08; // un poco m√°s grande si quieres que se note ‚Äúlejos‚Äù
  const aspect =
    (bgPlanetImg.naturalHeight || bgPlanetImg.height || 1) /
    (bgPlanetImg.naturalWidth  || bgPlanetImg.width  || 1);

  const w = targetW;
  const h = targetW * aspect;

  // Centro-derecha, arriba
  const x = (W - w) * 0.80;
  const y = H * 0.08;

  ctx.save();

  // Planeta base (sin blur)
  ctx.globalAlpha = 0.70;
  ctx.globalCompositeOperation = 'source-over';
  ctx.drawImage(bgPlanetImg, x, y, w, h);

  // Integraci√≥n: oscurecer con el color del espacio
  ctx.globalCompositeOperation = 'multiply';
  ctx.globalAlpha = 0.22;
  ctx.fillStyle = '#050611';
  ctx.fillRect(x, y, w, h);

  // Vi√±eta: bordes m√°s oscuros para ‚Äúmeterlo‚Äù en el fondo
  ctx.globalCompositeOperation = 'source-over';
  const g = ctx.createRadialGradient(x + w*0.5, y + h*0.5, w*0.10, x + w*0.5, y + h*0.5, w*0.70);
  g.addColorStop(0, 'rgba(0,0,0,0)');
  g.addColorStop(1, 'rgba(0,0,0,0.28)');
  ctx.globalAlpha = 1;
  ctx.fillStyle = g;
  ctx.fillRect(x, y, w, h);

  // Niebla fr√≠a por delante (opcional)
  ctx.globalAlpha = 0.2;
  ctx.fillStyle = 'rgba(20, 30, 70, 0.22)';
  ctx.fillRect(x, y, w, h);

  ctx.restore();
}


function draw(){
    ctx.clearRect(0,0,W,H);

	// SHAKE: mueve la ‚Äúc√°mara‚Äù un instante tras crash
	  ctx.save();
	  if (shakeT > 0){
		const k = shakeT / 0.18;              // 1..0
		const sx = ((Math.random()*2-1) * shakeAmp * k) | 0;
		const sy = ((Math.random()*2-1) * shakeAmp * k) | 0;
		ctx.translate(sx, sy);
	  }
    // fondo espacio
    ctx.fillStyle = "#040510";
    ctx.fillRect(0,0,W,H);

    
    
	drawStarsLayer(starsFar,  0.08, 0.60);  // m√°s lenta y algo m√°s visible
	drawBgPlanet(); // Planeta fijo (no se mueve con worldX)
	drawStarsLayer(starsNear, 0.10, 0.85);  // mucho m√°s r√°pida y m√°s brillante	
	drawPlanetSurface();


    // asteroides
    for (const a of asteroids){
      const spr = (a.variant===0) ? SPR.asteroidA : SPR.asteroidB;
      const size = (a.r*2)|0;
      ctx.save();
      ctx.translate(a.x|0, a.y|0);
      ctx.rotate(a.a);
      ctx.drawImage(spr, (-size/2)|0, (-size/2)|0, size, size);
      ctx.restore();
    }

    // TIE
    for (const t of ties){
      const frame = Math.floor((t.anim += 0.18) % 2);
      const spr = SPR.tie[frame];
      ctx.drawImage(spr, (t.x|0), ((t.y - t.h/2)|0), (t.w|0), (t.h|0));
    }

   for (const l of lasers){

	  // üé≤ radio variable del glow (flicker sutil)
	  const r = 4 + Math.random()*2;

	  // === GLOW redondeado ===
	  ctx.save();
	  ctx.globalAlpha = 0.35;
	  ctx.fillStyle = getCSS("--laser");

	  ctx.beginPath();
	  ctx.roundRect(
		(l.x|0) - 4,
		((l.y - 1)|0) - 4,
		(l.w + 8)|0,
		10,
		r        // üëà aqu√≠ usas el radio variable
	  );
	  ctx.fill();
	  ctx.restore();

	  // === Cuerpo fino ===
	  ctx.fillStyle = getCSS("--laser");
	  ctx.fillRect(l.x|0, (l.y - 1)|0, l.w|0, 2);

	  // === N√∫cleo blanco ===
	  ctx.fillStyle = "rgba(255,255,255,.55)";
	  ctx.fillRect((l.x + 2)|0, (l.y)|0, (l.w - 6)|0, 1);
	}




    // Halc√≥n
    drawFalcon();

    // UI
    if (!running){
      centerText("FASE 1 ¬∑ Campo de asteroides", 24, "rgba(233,238,247,.96)", -6);
      centerText("Click o Espacio para empezar", 16, "rgba(154,167,189,.95)", 26);
    }
    if (gameOver){
      centerText("GAME OVER", 40, "rgba(255,255,255,.95)", -8);
      centerText("Click/Espacio/R para reiniciar", 14, "rgba(154,167,189,.95)", 22);
    }

    // score grande
    if (running && !gameOver){
      ctx.save();
      ctx.globalAlpha = 0.20;
      ctx.fillStyle = "#e9eef7";
      ctx.font = "800 64px ui-sans-serif,system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText(String(Math.floor(score)), W/2, 14);
      ctx.restore();
    }
	
	drawParticles();

	// Aviso de fase (aparece y se desvanece)
	if (!gameOver && phaseT > 0 && phaseMsg){
		// decae con el tiempo real
		// (phaseT se reduce en loop, por si el frame rate cambia)
		const tLeft = phaseT;
		const t = phaseDur - tLeft;
		const fade = 0.35;
		let a = 1;
		if (t < fade) a = t / fade;
		else if (tLeft < fade) a = tLeft / fade;
		a = Math.max(0, Math.min(1, a));
		ctx.save();
		ctx.globalAlpha = 0.92 * a;
		ctx.fillStyle = "rgba(0,0,0,0.22)";
		//ctx.fillRect(0, (H/2 - 34)|0, W, 68);
		centerText(phaseMsg, 26, "rgba(233,238,247,.98)", 0);
		ctx.restore();
	}
	// ‚úÖ MUY IMPORTANTE: volver al estado previo al shake
	ctx.restore();


  }

function drawFalcon(){
  ctx.save();
  ctx.translate((ship.x|0), (ship.y|0));
  ctx.rotate(ship.rot);

  // --- Motor: arco azul pegado a la parte trasera (sin pluma) ---
  // Intensidad: se "enciende" con cada clic y decae suavemente
  const pulse = ship.engineFlash ? 1.0 : 0.15;

  ctx.save();
  ctx.globalCompositeOperation = "lighter";

  // Centro del arco (en coords locales del Falcon)
  const gx = -19, gy = 0;
  const r  = 30;

  // Glow exterior
  ctx.lineCap = "round";
  ctx.shadowColor = `rgba(70, 210, 255, ${0.85*pulse})`;
  ctx.shadowBlur  = 22 * pulse;

  const grad = ctx.createRadialGradient(gx, gy, 2, gx, gy, r + 10);
  grad.addColorStop(0.00, `rgba(255,255,255, ${0.70*pulse})`);
  grad.addColorStop(0.35, `rgba(120,235,255, ${0.55*pulse})`);
  grad.addColorStop(0.70, `rgba(0,160,255, ${0.35*pulse})`);
  grad.addColorStop(1.00, `rgba(0,110,255, 0)`);
  ctx.strokeStyle = grad;
  ctx.lineWidth = 7;

  // Arco (mitad izquierda) para "abrazar" la trasera redondeada
  ctx.beginPath();
  ctx.arc(gx, gy, r, Math.PI*0.64, Math.PI*1.36);
  ctx.stroke();

  // N√∫cleo m√°s brillante, m√°s fino
  ctx.shadowBlur = 10 * pulse;
  ctx.strokeStyle = `rgba(190,245,255, ${0.95*pulse})`;
  ctx.lineWidth = 3;

  ctx.beginPath();
  ctx.arc(gx+0.5, gy, r-1.5, Math.PI*0.64, Math.PI*1.36);
  ctx.stroke();

  ctx.restore();


  if (falconReady){
    ctx.imageSmoothingEnabled = false; // pixel perfecto

    const scale = 1.15; // AJUSTA tama√±o aqu√≠
    const w = falconImg.width  * scale;
    const h = falconImg.height * scale;

    ctx.drawImage(falconImg, (-w/2)|0, (-h/2)|0, w|0, h|0);
  }

  ctx.restore();
}

  // --- Fondo ---
  function drawStarsLayer(stars, parallax, baseAlpha){
  const off = (worldX * parallax) % W;
  const t = performance.now() * 0.001;
  ctx.save();
  for (let i=0;i<stars.length;i++){
    const s = stars[i];
    const x = ((s.x * s.sp + (W - off)) % W);
    const y = s.y;
    const tw = 0.65 + 0.35 * Math.sin(t*1.8 + s.tw);
    const a  = baseAlpha * tw;

    // color: mayor√≠a blanco, algunas azuladas
    if (s.tint){
      ctx.fillStyle = `rgba(125,211,252,${0.80*a})`;
    }else{
      ctx.fillStyle = `rgba(255,255,255,${0.85*a})`;
    }
    const r = s.r;
    ctx.fillRect(x|0, y|0, r|0 || 1, r|0 || 1);
  }
  ctx.restore();
}


  function drawSpeedStreaks(){
    ctx.save();
    ctx.globalAlpha = 0.14;
    ctx.fillStyle = "rgba(233,238,247,1)";
    const off = (worldX * 0.7) % 180;
    for (let i=0;i<22;i++){
      const x = (W - off - i*90) | 0;
      const y = (26 + (i*21) % (H-52)) | 0;
      ctx.fillRect(x, y, 26, 1);
    }
    ctx.restore();
  }

  function centerText(text, size, color, yOffset){
    ctx.save();
    ctx.fillStyle = color;
    ctx.font = `700 ${size}px ui-sans-serif,system-ui`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, W/2, H/2 + yOffset);
    ctx.restore();
  }

  function getCSS(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "#ff4d4d";
  }

  // --- Sprites pixel art (mejor falcon + TIE + asteroides) ---

function makeSprites(){
  // helper: canvas peque√±o para sprites
  const mk = (w,h) => {
	  const c = document.createElement("canvas");
	  c.width = w; c.height = h;
	  const g = c.getContext("2d", { willReadFrequently: true });
	  g.imageSmoothingEnabled = false;
	  return [c,g];
	};


  function px(g,x,y,w,h,color){ g.fillStyle=color; g.fillRect(x|0,y|0,w|0,h|0); }

  function hexToRgb(hex){
    if (!hex || !hex.startsWith("#")) return {r:0,g:0,b:0};
    const n = parseInt(hex.slice(1), 16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }

  function outline(g, color){
    const img = g.getImageData(0,0,g.canvas.width,g.canvas.height);
    const d = img.data;
    const w = img.width, h = img.height;
    const out = g.getImageData(0,0,w,h);
    const od = out.data;

    const rgb = hexToRgb(color);

    function a(ix,iy){
      if (ix<0||iy<0||ix>=w||iy>=h) return 0;
      return d[(iy*w+ix)*4+3];
    }

    for (let y=0;y<h;y++){
      for (let x=0;x<w;x++){
        if (a(x,y)===0) continue;
        const edge = (a(x-1,y)===0 || a(x+1,y)===0 || a(x,y-1)===0 || a(x,y+1)===0);
        if (edge){
          const i=(y*w+x)*4;
          od[i]=rgb.r; od[i+1]=rgb.g; od[i+2]=rgb.b; od[i+3]=220;
        }
      }
    }
    g.putImageData(out,0,0);
    g.putImageData(img,0,0);
  }

  // Motor glow
  const engine = [];
  for (let f=0; f<2; f++){
    const [c,g] = mk(18,12);
    g.clearRect(0,0,18,12);
    px(g, 2, 3, 12, 6, "rgba(125,211,252,.85)");
    px(g, 3, 4, 10, 4, f ? "rgba(255,255,255,.35)" : "rgba(255,255,255,.18)");
    outline(g, "#0b1020");
    engine.push(c);
  }


// TIE (2 frames) ‚Äî alas hexagonales tipo pel√≠cula
const tie = [];

// Hex√°gono con caras planas arriba/abajo y recorte en los laterales
function hexWingLR(g, x, y, w, h, color){
  const inset = Math.max(3, Math.round(h * 0.22)); // ~4 si h=18
  const mid = (h - 1) * 0.5;

  g.fillStyle = color;

  for (let yy = 0; yy < h; yy++){
    const t  = Math.abs(yy - mid) / mid; // 0 centro, 1 bordes
    const dx = Math.round(inset * t);    // m√°s recorte arriba/abajo
    const x0 = x + dx;
    const ww = w - 2*dx;
    if (ww > 0) g.fillRect(x0, y + yy, ww, 1);
  }
}

for (let f = 0; f < 2; f++){
  const [c,g] = mk(44, 30);
  g.clearRect(0, 0, 44, 30);

  const wing = "#374151";
  const body = "#9ca3af";
  const dark = "#111827";

  // Colores brazos 3D (m√°s visibles)
  const armTop = "#0f172a";            // ‚Äúencima‚Äù
  const armBot = "rgba(0,0,0,.55)";    // ‚Äúdebajo‚Äù
  const armHi  = "rgba(255,255,255,.10)";

  // Alas hexagonales (m√°s anchas para que no parezcan flechas)
  const WING_W = 16, WING_H = 18;
  const Lx = 0, Rx = 28, Wy = 6;

  // === Brazo derecho ‚Äúdebajo‚Äù (dibujar ANTES de alas, y m√°s abajo para que asome) ===
  px(g, 26, 18, 6, 2, armBot);
  px(g, 24, 17, 6, 2, armBot);
  px(g, 25, 19, 4, 1, armHi);

  // === Alas ===
  hexWingLR(g, Lx, Wy, WING_W, WING_H, wing);
  hexWingLR(g, Rx, Wy, WING_W, WING_H, wing);

  // Paneles internos siguiendo la misma geometr√≠a del hex√°gono
  const insetWing = Math.max(3, Math.round(WING_H * 0.22));
  const mid = (WING_H - 1) * 0.5;

  for (let yy = 2; yy < WING_H - 2; yy += 3){
    const t  = Math.abs(yy - mid) / mid;
    const dx = Math.round(insetWing * t);
    const ww = WING_W - 2*dx;

    px(g, Lx + dx, Wy + yy, ww, 1, "rgba(0,0,0,.22)");
    px(g, Rx + dx, Wy + yy, ww, 1, "rgba(0,0,0,.22)");
  }

  // === Brazo izquierdo ‚Äúencima‚Äù (dibujar DESPU√âS de alas, y m√°s arriba para que asome) ===
  px(g, 12, 10, 6, 2, armTop);
  px(g, 14, 11, 6, 2, armTop);
  px(g, 13, 9, 4, 1, armHi);

  // Cockpit (redonda, estilo 8-bit)
  const cx = 22, cy = 15, r = 6;

  // c√≠rculo ‚Äúpixel‚Äù (disco)
  for (let yy = -r; yy <= r; yy++){
    const dx = Math.floor(Math.sqrt(r*r - yy*yy));
    px(g, cx - dx, cy + yy, dx*2 + 1, 1, body);
  }

  // interior m√°s oscuro
  const r2 = 4;
  for (let yy = -r2; yy <= r2; yy++){
    const dx = Math.floor(Math.sqrt(r2*r2 - yy*yy));
    px(g, cx - dx, cy + yy, dx*2 + 1, 1, "#6b7280");
  }

  // brillo peque√±o
  px(g, cx - 1, cy - 1, 2, 2, "rgba(255,255,255,.12)");

  // ‚ÄúDisparo‚Äù rojo en frame 2
  if (f === 1){
    px(g, 17, 15, 2, 1, "rgba(255,77,77,.75)");
    px(g, 25, 15, 2, 1, "rgba(255,77,77,.75)");
  }

  outline(g, "#0b1020");
  tie.push(c);
}


  // Asteroides
  function makeAsteroidSprite(size, variant){
  // Pixel-art asteroid (no gradients): irregular but rounded silhouette + 3-tone palette + simple dithering.
  // Render at low-res then upscale with smoothing OFF for chunky pixels.
  const low = Math.max(24, (size/2)|0);     // e.g. 64->32, 44->24
  const [cl, gl] = mk(low, low);
  gl.clearRect(0,0,low,low);
  gl.imageSmoothingEnabled = false;

  const rnd = mulberry32(0xA53C9E + variant*0x1F123BB);
  const cx = low/2, cy = low/2;

  // --- Build a rounded irregular path (quadratic midpoints) ---
  const pts = 28;
  const baseR = low * (0.34 + 0.02*rnd());
  const jitter = low * 0.065;

  const P = [];
  for (let i=0;i<pts;i++){
    const a = (i/pts) * Math.PI*2;
    const rr = baseR + (rnd()*2-1)*jitter + (Math.sin(a*3 + rnd()*2)*jitter*0.18);
    P.push([ cx + Math.cos(a)*rr, cy + Math.sin(a)*rr ]);
  }

  gl.beginPath();
  for (let i=0;i<pts;i++){
    const p0 = P[i];
    const p1 = P[(i+1)%pts];
    const mx = (p0[0]+p1[0])*0.5;
    const my = (p0[1]+p1[1])*0.5;
    if (i===0) gl.moveTo(mx,my);
    gl.quadraticCurveTo(p0[0],p0[1],mx,my);
  }
  gl.closePath();

  // Palette (highlight / mid / shade)
  const pal = variant
    ? ["#8c95a5", "#5f6878", "#2d3340"]
    : ["#96a0b2", "#69738a", "#2a3242"];

  // 4x4 Bayer matrix for ordered dithering
  const bayer4 = [
    [ 0,  8,  2, 10],
    [12,  4, 14,  6],
    [ 3, 11,  1,  9],
    [15,  7, 13,  5]
  ];

  // Draw pixels by testing inside the path (robust, no ImageData needed)
  for (let y=0;y<low;y++){
    for (let x=0;x<low;x++){
      if (!gl.isPointInPath(x+0.5,y+0.5)) continue;

      // Light from top-left
      const nx = (x - cx) / (baseR*1.10);
      const ny = (y - cy) / (baseR*1.10);
      let s = 0.58 - (nx*0.55 + ny*0.75);
      s = Math.max(0, Math.min(1, s));

      const t = (bayer4[y&3][x&3]/16) - 0.5;
      let idx;
      if (s > 0.70 + t*0.10) idx = 0;
      else if (s > 0.44 + t*0.10) idx = 1;
      else idx = 2;

      gl.fillStyle = pal[idx];
      gl.fillRect(x,y,1,1);
    }
  }

  // Speckles
  for (let n=0;n<140;n++){
    const x = (rnd()*low)|0;
    const y = (rnd()*low)|0;
    if (!gl.isPointInPath(x+0.5,y+0.5)) continue;
    gl.fillStyle = (rnd()<0.5) ? "rgba(255,255,255,.35)" : "rgba(0,0,0,.35)";
    gl.fillRect(x,y,1,1);
  }

  // Pixel craters (rings)
  for (let k=0;k<6;k++){
    let px=0, py=0, tries=0;
    while (tries++ < 30){
      px = (rnd()*low)|0;
      py = (rnd()*low)|0;
      if (gl.isPointInPath(px+0.5, py+0.5)) break;
    }
    const cr = 2 + ((rnd()*4)|0); // 2..5
    for (let yy=-cr-1; yy<=cr+1; yy++){
      for (let xx=-cr-1; xx<=cr+1; xx++){
        const rr = Math.hypot(xx,yy);
        const x = px+xx, y = py+yy;
        if (x<0||y<0||x>=low||y>=low) continue;
        if (!gl.isPointInPath(x+0.5,y+0.5)) continue;

        if (rr > cr+0.6) continue;
        if (rr > cr-0.2) { gl.fillStyle = "rgba(0,0,0,.35)"; gl.fillRect(x,y,1,1); }        // ring
        else if (rr < cr*0.55) { gl.fillStyle = "rgba(255,255,255,.10)"; gl.fillRect(x,y,1,1); } // inner
      }
    }
    // slight shadow bottom-right
    gl.fillStyle = "rgba(0,0,0,.18)";
    gl.fillRect(px+1, py+1, 1, 1);
  }

  // Outline (low-res) to read on space background
  outline(gl, "#0b1020");

  // Upscale to final size with no smoothing
  const [c,g] = mk(size,size);
  g.clearRect(0,0,size,size);
  g.imageSmoothingEnabled = false;
  g.drawImage(cl, 0,0, low,low, 0,0, size,size);
  outline(g, "#0b1020");
  return c;
}

  const asteroidA = makeAsteroidSprite(32, 0);
  const asteroidB = makeAsteroidSprite(32, 1);

  // OJO: no devolvemos "falcon" (se dibuja con falconImg)
  return { engine, tie, asteroidA, asteroidB };
}

function loop(t){
    const dt = Math.min(0.033, (t - lastT)/1000);
    lastT = t;
	
	  // ‚úÖ esto SIEMPRE, incluso en game over
	updateParticles(dt);
	if (!canRestart) {
	  restartTimer -= dt;
	 if (restartTimer <= 0) {
		canRestart = true;
	  }
	}

    if (running && !gameOver) update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
